{% extends "base.html" %}

{% block title %}Edit Expense - MoneyTrack{% endblock %}

{% block page_title %}Edit Expense{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb-item">
    <i class="fas fa-home"></i>
    <span>Dashboard</span>
</div>
<span class="breadcrumb-separator">/</span>
<div class="breadcrumb-item">
    <i class="fas fa-history"></i>
    <span>History</span>
</div>
<span class="breadcrumb-separator">/</span>
<div class="breadcrumb-item">
    <i class="fas fa-edit"></i>
    <span>Edit</span>
</div>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3">
    <!-- Main Form -->
    <div class="lg:col-span-2">
        <div class="card" data-aos="fade-up">
            <div class="card-header">
                <h3 class="card-title">Edit Expense Entry</h3>
                <p class="card-subtitle">Update your expense details</p>
            </div>
            <div class="card-body">
                <form action="/update/{{ expenses[0] }}" method="POST" id="editExpenseForm">
                    <input type="hidden" name="id" value="{{ expenses[0] }}">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div class="form-group">
                            <label for="date" class="form-label">
                                <i class="fas fa-calendar-alt"></i>
                                Date & Time
                            </label>
                            <input type="datetime-local" 
                                   id="date" 
                                   name="date" 
                                   class="form-control" 
                                   value="{{ expenses[2] }}" 
                                   required>
                        </div>

                        <div class="form-group">
                            <label for="amount" class="form-label">
                                <i class="fas fa-dollar-sign"></i>
                                Amount (GH$)
                            </label>
                            <input type="number" 
                                   id="amount" 
                                   name="amount" 
                                   class="form-control" 
                                   min="0" 
                                   step="0.01" 
                                   value="{{ expenses[4] }}" 
                                   required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="expensename" class="form-label">
                            <i class="fas fa-tag"></i>
                            Expense Description
                        </label>
                        <input type="text" 
                               id="expensename" 
                               name="expensename" 
                               class="form-control" 
                               value="{{ expenses[3] }}" 
                               required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div class="form-group">
                            <label for="category" class="form-label">
                                <i class="fas fa-list"></i>
                                Category
                            </label>
                            <select id="category" name="category" class="form-control form-select" required>
                                <option value="food" {{ 'selected' if expenses[6] == 'food' else '' }}>🍽️ Food & Dining</option>
                                <option value="entertainment" {{ 'selected' if expenses[6] == 'entertainment' else '' }}>🎬 Entertainment</option>
                                <option value="business" {{ 'selected' if expenses[6] == 'business' else '' }}>💼 Business</option>
                                <option value="rent" {{ 'selected' if expenses[6] == 'rent' else '' }}>🏠 Rent & Housing</option>
                                <option value="EMI" {{ 'selected' if expenses[6] == 'EMI' else '' }}>💳 EMI & Loans</option>
                                <option value="transport" {{ 'selected' if expenses[6] == 'transport' else '' }}>🚗 Transportation</option>
                                <option value="healthcare" {{ 'selected' if expenses[6] == 'healthcare' else '' }}>🏥 Healthcare</option>
                                <option value="education" {{ 'selected' if expenses[6] == 'education' else '' }}>📚 Education</option>
                                <option value="shopping" {{ 'selected' if expenses[6] == 'shopping' else '' }}>🛍️ Shopping</option>
                                <option value="other" {{ 'selected' if expenses[6] == 'other' else '' }}>📦 Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="paymode" class="form-label">
                                <i class="fas fa-credit-card"></i>
                                Payment Method
                            </label>
                            <select id="paymode" name="paymode" class="form-control form-select" required>
                                <option value="cash" {{ 'selected' if expenses[5] == 'cash' else '' }}>💵 Cash</option>
                                <option value="debitcard" {{ 'selected' if expenses[5] == 'debitcard' else '' }}>💳 Debit Card</option>
                                <option value="creditcard" {{ 'selected' if expenses[5] == 'creditcard' else '' }}>💎 Credit Card</option>
                                <option value="epayment" {{ 'selected' if expenses[5] == 'epayment' else '' }}>📱 E-Payment</option>
                                <option value="onlinebanking" {{ 'selected' if expenses[5] == 'onlinebanking' else '' }}>🏦 Online Banking</option>
                                <option value="mobilemoney" {{ 'selected' if expenses[5] == 'mobilemoney' else '' }}>📲 Mobile Money</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            Update Expense
                        </button>
                        <a href="/display" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            Cancel
                        </a>
                        <a href="/delete/{{ expenses[0] }}" 
                           class="btn btn-danger"
                           onclick="return confirm('Are you sure you want to delete this expense?')">
                            <i class="fas fa-trash"></i>
                            Delete
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div>
        <!-- Current Details -->
        <div class="card mb-4" data-aos="fade-left" data-aos-delay="200">
            <div class="card-header">
                <h3 class="card-title">📋 Current Details</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Amount</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger-color);">GH${{ expenses[4] }}</div>
                    </div>
                    
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Category</div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ expenses[6].title() }}</div>
                    </div>
                    
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Payment Method</div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ expenses[5].title() }}</div>
                    </div>
                    
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Date</div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ expenses[2] }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Tips -->
        <div class="card" data-aos="fade-left" data-aos-delay="300">
            <div class="card-header">
                <h3 class="card-title">💡 Edit Tips</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="background-color: var(--primary-color); color: white; 
                                    border-radius: 50%; width: 24px; height: 24px; 
                                    display: flex; align-items: center; justify-content: center; 
                                    font-size: 0.75rem; flex-shrink: 0;">
                            ✓
                        </div>
                        <div>
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">Double-check amounts</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                Make sure the amount is correct before updating
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="background-color: var(--success-color); color: white; 
                                    border-radius: 50%; width: 24px; height: 24px; 
                                    display: flex; align-items: center; justify-content: center; 
                                    font-size: 0.75rem; flex-shrink: 0;">
                            📊
                        </div>
                        <div>
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">Category matters</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                Correct categories help with better reporting
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="background-color: var(--warning-color); color: white; 
                                    border-radius: 50%; width: 24px; height: 24px; 
                                    display: flex; align-items: center; justify-content: center; 
                                    font-size: 0.75rem; flex-shrink: 0;">
                            🗑️
                        </div>
                        <div>
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">Delete carefully</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                Deleted expenses cannot be recovered
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Fix date format for datetime-local input
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('date');
        const dateValue = "{{ expenses[2] }}";
        
        if (dateValue) {
            // Convert the date to the correct format for datetime-local
            const date = new Date(dateValue);
            const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            dateInput.value = localDateTime;
        }
    });

    // Form validation and enhancement
    const form = document.getElementById('editExpenseForm');
    const amountInput = document.getElementById('amount');

    // Format amount input
    amountInput.addEventListener('input', function() {
        let value = this.value;
        if (value && !isNaN(value) && parseFloat(value) > 0) {
            this.style.borderColor = 'var(--success-color)';
        } else {
            this.style.borderColor = 'var(--danger-color)';
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        const amount = parseFloat(amountInput.value);
        
        if (amount <= 0) {
            e.preventDefault();
            Toastify({
                text: "Please enter a valid amount greater than 0",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(135deg, #ef4444, #dc2626)",
                close: true
            }).showToast();
            return;
        }

        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.disabled = true;

        // Re-enable button after a delay (in case of errors)
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 5000);
    });

    // Highlight changes
    const inputs = form.querySelectorAll('input, select');
    const originalValues = {};
    
    inputs.forEach(input => {
        originalValues[input.name] = input.value;
        
        input.addEventListener('change', function() {
            if (this.value !== originalValues[this.name]) {
                this.style.backgroundColor = '#fef3c7';
                this.style.borderColor = 'var(--warning-color)';
            } else {
                this.style.backgroundColor = '';
                this.style.borderColor = '';
            }
        });
    });
</script>
{% endblock %}
